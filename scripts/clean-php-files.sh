#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ PHP Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¾Ñ‚ BOM Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²

echo "ðŸ”§ Ð—Ð°Ð¿ÑƒÑÐº Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ PHP Ñ„Ð°Ð¹Ð»Ð¾Ð²..."

# ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cd "$(dirname "$0")/.." || exit 1

echo "ðŸ“ Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $(pwd)"

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° BOM ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
echo "ðŸ§¹ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ BOM ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð¸Ð· PHP Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
find ./src -name "*.php" -type f -exec sed -i '1s/^\xEF\xBB\xBF//' {} \; 2>/dev/null || true

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ trailing Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð²
echo "âœ‚ï¸  Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð»Ð¸ÑˆÐ½Ð¸Ñ… Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð² Ð² ÐºÐ¾Ð½Ñ†Ðµ ÑÑ‚Ñ€Ð¾Ðº..."
find ./src -name "*.php" -type f -exec sed -i 's/[[:space:]]*$//' {} \; 2>/dev/null || true

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð² Ð¿ÐµÑ€ÐµÐ´ <?php
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð±ÐµÐ»Ð¾Ð² Ð¿ÐµÑ€ÐµÐ´ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÑŽÑ‰Ð¸Ð¼Ð¸ Ñ‚ÐµÐ³Ð°Ð¼Ð¸ PHP..."
find ./src -name "*.php" -type f -exec bash -c '
    if head -1 "$1" | grep -q "^[[:space:]]\+<\?php"; then
        echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹ Ð¿ÐµÑ€ÐµÐ´ <?php Ð² Ñ„Ð°Ð¹Ð»Ðµ: $1"
        sed -i "1s/^[[:space:]]*<?php/<?php/" "$1"
        echo "âœ… Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾: $1"
    fi
' _ {} \;

echo "âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo "ðŸ³ Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿ÐµÑ€ÐµÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹:"
echo "   docker-compose down && docker-compose up --build"
